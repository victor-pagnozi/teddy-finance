FROM node:22-alpine

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-workspace.yaml turbo.json tsconfig.base.json ./
COPY packages ./packages
COPY apps/server/package.json ./apps/server/package.json
COPY apps/website/package.json ./apps/website/package.json

RUN pnpm install

COPY . .

EXPOSE 3000

CMD ["sh", "-lc", "pnpm -w install --no-frozen-lockfile && pnpm --filter @teddy/server install --no-frozen-lockfile && cd apps/server && pnpm dev"]
